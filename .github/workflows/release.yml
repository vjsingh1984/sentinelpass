name: Release CI

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Determine if this is a release or preflight run
  setup:
    name: Release Setup
    runs-on: ubuntu-latest
    outputs:
      is-release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        name: Check if release
        run: |
          if [[ "${GITHUB_REF_NAME}" == v* ]]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi
      - id: version
        name: Determine version
        run: |
          if [[ "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION=$(awk -F'"' '/^\[workspace\.package\]/{f=1;next} /^\[/{f=0} f && /^version/{print $2;exit}' Cargo.toml)
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

  # Package and smoke test across platforms
  # Downloads artifacts from rust.yml if available, otherwise builds fresh
  package:
    name: Package (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            shell: bash
          - os: macos-latest
            platform: macos
            shell: bash
          - os: windows-latest
            platform: windows
            shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-rust-env
        with:
          cache-key-prefix: release-${{ matrix.platform }}

      # Try to download cached build artifacts from rust.yml
      - name: Download cached Rust artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: rust-build-${{ matrix.platform }}
          path: target/release

      # Download web artifacts if available
      - name: Download cached web artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: web-artifacts-${{ matrix.platform }}
          path: .

      # If artifacts weren't available, build fresh
      - name: Build release binaries (if not cached)
        shell: ${{ matrix.shell }}
        run: |
          if [ ! -f "target/release/sentinelpass${{ runner.os == 'Windows' && '.exe' || '' }}" ]; then
            cargo build --release --bin sentinelpass --bin sentinelpass-daemon --bin sentinelpass-host --bin sentinelpass-ui
          else
            echo "Using cached build artifacts"
          fi

      - name: Inject release version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.setup.outputs.version }}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          if [ "${{ needs.setup.outputs.is-release }}" == "true" ]; then
            sed -i.bak "/\[workspace\.package\]/,/^\[/{s/^version = \".*\"/version = \"${VERSION}\"/;}" Cargo.toml && rm -f Cargo.toml.bak
            cargo update --workspace
          fi

      - name: Package archives (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          portable_name="sentinelpass-${VERSION}-${{ matrix.platform }}.tar.gz"
          installer_name="sentinelpass-installer-${VERSION}-${{ matrix.platform }}.tar.gz"

          mkdir -p dist/portable/root
          cp target/release/sentinelpass dist/portable/root/
          cp target/release/sentinelpass-daemon dist/portable/root/
          cp target/release/sentinelpass-host dist/portable/root/
          cp target/release/sentinelpass-ui dist/portable/root/
          cp README.md LICENSE dist/portable/root/
          tar -czf "dist/${portable_name}" -C dist/portable/root .

          mkdir -p dist/installer/root/target/release
          cp target/release/sentinelpass dist/installer/root/target/release/
          cp target/release/sentinelpass-daemon dist/installer/root/target/release/
          cp target/release/sentinelpass-host dist/installer/root/target/release/
          cp target/release/sentinelpass-ui dist/installer/root/target/release/
          cp install.sh install-user.sh install-user.command README.md LICENSE dist/installer/root/
          cp -R installation dist/installer/root/
          mkdir -p dist/installer/root/browser-extension
          cp -R browser-extension/chrome dist/installer/root/browser-extension/
          if [ -d browser-extension/firefox ]; then
            cp -R browser-extension/firefox dist/installer/root/browser-extension/
          fi
          tar -czf "dist/${installer_name}" -C dist/installer/root .

      - name: Package archives (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $portableName = "sentinelpass-${VERSION}-${{ matrix.platform }}.zip"
          $installerName = "sentinelpass-installer-${VERSION}-${{ matrix.platform }}.zip"

          New-Item -ItemType Directory -Force -Path dist/portable/root | Out-Null
          Copy-Item target/release/sentinelpass.exe dist/portable/root/
          Copy-Item target/release/sentinelpass-daemon.exe dist/portable/root/
          Copy-Item target/release/sentinelpass-host.exe dist/portable/root/
          Copy-Item target/release/sentinelpass-ui.exe dist/portable/root/
          Copy-Item README.md dist/portable/root/
          Copy-Item LICENSE dist/portable/root/
          Compress-Archive -Path dist/portable/root/* -DestinationPath "dist/$portableName" -Force

          New-Item -ItemType Directory -Force -Path dist/installer/root/target/release | Out-Null
          New-Item -ItemType Directory -Force -Path dist/installer/root/installation | Out-Null
          New-Item -ItemType Directory -Force -Path dist/installer/root/browser-extension | Out-Null

          Copy-Item target/release/sentinelpass.exe dist/installer/root/target/release/
          Copy-Item target/release/sentinelpass-daemon.exe dist/installer/root/target/release/
          Copy-Item target/release/sentinelpass-host.exe dist/installer/root/target/release/
          Copy-Item target/release/sentinelpass-ui.exe dist/installer/root/target/release/

          Copy-Item install.ps1 dist/installer/root/
          Copy-Item install-user.cmd dist/installer/root/
          Copy-Item register-chrome.ps1 dist/installer/root/
          Copy-Item register-firefox.ps1 dist/installer/root/
          Copy-Item update-extension-id.ps1 dist/installer/root/

          Copy-Item installation/install.ps1 dist/installer/root/installation/
          Copy-Item installation/com.passwordmanager.host.json dist/installer/root/installation/

          Copy-Item -Recurse browser-extension/chrome dist/installer/root/browser-extension/
          if (Test-Path browser-extension/firefox) {
            Copy-Item -Recurse browser-extension/firefox dist/installer/root/browser-extension/
          }
          Copy-Item README.md LICENSE dist/installer/root/
          Compress-Archive -Path dist/installer/root/* -DestinationPath "dist/$installerName" -Force

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist/*
          retention-days: 7

  # Bundle smoke tests
  bundle-smoke:
    name: Bundle Smoke Test (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: package
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist

      - name: Verify portable archive contents
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "windows" ]; then
            unzip -l dist/*.zip | grep sentinelpass
          else
            tar -tzf dist/*.tar.gz | grep -E 'sentinelpass' | head -5
          fi

      - name: Verify installer archive contents
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "windows" ]; then
            unzip -l dist/*installer*.zip | grep -E '(install-user|installation)'
          else
            tar -tzf dist/*installer*.tar.gz | grep -E 'install-user'
            tar -tzf dist/*installer*.tar.gz | grep -E 'installation'
          fi

  # Native installer smoke tests (only for real releases)
  native-installer-smoke:
    name: Native Installer Smoke (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: package
    if: needs.setup.outputs.is-release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist

      - name: Setup build environment
        uses: ./.github/actions/setup-rust-env
        with:
          cache-key-prefix: installer-${{ matrix.platform }}
          web-build: false

      - name: Build Tauri bundles
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          cd sentinelpass-ui
          cargo tauri build --verbose

      - name: List bundle outputs
        run: |
          echo "Tauri bundle outputs:"
          find sentinelpass-ui/target/release/bundle -type f || echo "No bundles found"

      - name: Upload Tauri bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}
          path: sentinelpass-ui/target/release/bundle/*
          retention-days: 7

  # Create GitHub release and upload assets
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [setup, bundle-smoke, native-installer-smoke]
    if: needs.setup.outputs.is-release == 'true'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: release-assets
          merge-multiple: true

      - name: Download Tauri bundle artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tauri-bundles-*
          path: tauri-assets
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          cd release-assets
          sha256sum * > sha256sums.txt
          cat sha256sums.txt

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "Release v${VERSION}

          ## Installation

          ### Linux
          \`\`\`bash
          # Download installer
          wget https://github.com/vjsingh1984/sentinelpass/releases/download/v${VERSION}/sentinelpass-installer-${VERSION}-linux.tar.gz
          tar -xzf sentinelpass-installer-${VERSION}-linux.tar.gz
          cd installer-root
          ./install.sh
          \`\`\`

          ### macOS
          \`\`\`bash
          # Download installer
          curl -LO https://github.com/vjsingh1984/sentinelpass/releases/download/v${VERSION}/sentinelpass-installer-${VERSION}-macos.tar.gz
          tar -xzf sentinelpass-installer-${VERSION}-macos.tar.gz
          cd installer-root
          ./install-user.command
          \`\`\`

          ### Windows
          \`\`\`powershell
          # Download installer
          Invoke-WebRequest -Uri https://github.com/vjsingh1984/sentinelpass/releases/download/v${VERSION}/sentinelpass-installer-${VERSION}-windows.zip -OutFile installer.zip
          Expand-Archive -Path installer.zip
          cd installer-root
          .\install-user.cmd
          \`\`\`

          ## Browser Extensions

          ### Chrome
          Download [sentinelpass-chrome-${VERSION}.zip](https://github.com/vjsingh1984/sentinelpass/releases/download/v${VERSION}/sentinelpass-chrome-${VERSION}.zip), unzip, and load as unpacked extension.

          ### Firefox
          Download [sentinelpass-firefox-${VERSION}.zip](https://github.com/vjsingh1984/sentinelpass/releases/download/v${VERSION}/sentinelpass-firefox-${VERSION}.zip) and install temporarily.

          ## Verify Download

          \`\`\`bash
          sha256sum -c sha256sums.txt
          \`\`\`"
        # or use draft: true and edit later
      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          gh release upload "v${VERSION}" release-assets/* --clobber

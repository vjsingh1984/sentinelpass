name: Rust CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Quick format check - runs first, fails fast
  format:
    name: Check Rust Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Clippy lint - runs in parallel with format
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust-env
        with:
          web-build: false
      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  # TypeScript TDD - runs in parallel
  web_tdd:
    name: TypeScript TDD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust-env
        with:
          linux-deps: false
      - name: Type-check web sources
        run: npm run web:typecheck
      - name: Run TypeScript unit tests with coverage
        run: npm run test:ts
      - name: Upload TypeScript coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: ts-coverage
          path: coverage/ts/lcov.info
          if-no-files-found: error

  # Build and test across all platforms - produces cached artifacts
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [format, clippy]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: linux
          - os: macos-latest
            platform: macos
            artifact_name: macos
          - os: windows-latest
            platform: windows
            artifact_name: windows

    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-rust-env
        with:
          cache-key-prefix: ci-${{ matrix.os }}

      - name: Run tests
        run: cargo test --workspace --verbose

      - name: Build release binaries
        run: cargo build --release --bin sentinelpass --bin sentinelpass-daemon --bin sentinelpass-host --bin sentinelpass-ui

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-build-${{ matrix.platform }}
          path: |
            target/release/sentinelpass*
            target/release/*.exe
          retention-days: 7
          if-no-files-found: error

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-artifacts-${{ matrix.platform }}
          path: |
            sentinelpass-ui/dist
            browser-extension/chrome/dist
            browser-extension/firefox/dist
          retention-days: 7

  # Rust coverage - runs after tests pass
  coverage:
    name: Rust LLVM Coverage
    runs-on: ubuntu-latest
    needs: [build-and-test]
    env:
      RUST_COVERAGE_MIN: "50"
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust-env
        with:
          web-build: false
          linux-deps: false
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Run Rust coverage
        run: bash scripts/coverage-rust.sh
      - name: Upload Rust coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-llvm-coverage
          path: target/llvm-cov/lcov.info
          if-no-files-found: error

  # Report overall status
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format, clippy, web_tdd, build-and-test, coverage]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.format.result }}" != "success" ] || \
             [ "${{ needs.clippy.result }}" != "success" ] || \
             [ "${{ needs.web_tdd.result }}" != "success" ] || \
             [ "${{ needs.build-and-test.result }}" != "success" ] || \
             [ "${{ needs.coverage.result }}" != "success" ]; then
            echo "Some CI jobs failed. Please check the logs."
            exit 1
          fi
          echo "All CI jobs passed successfully!"

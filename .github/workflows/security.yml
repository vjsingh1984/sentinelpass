name: Security CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rust_audit:
    name: RustSec Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit
      - name: Run cargo audit
        run: cargo audit --deny warnings

  npm_audit_root:
    name: npm Audit (Root)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install root dependencies
        run: npm ci
      - name: Run npm audit (high+)
        run: npm audit --audit-level=high

  npm_audit_e2e:
    name: npm Audit (Extension E2E)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: browser-extension/e2e/package-lock.json
      - name: Install e2e dependencies
        working-directory: browser-extension/e2e
        run: npm ci
      - name: Run npm audit (high+)
        working-directory: browser-extension/e2e
        run: npm audit --audit-level=high

  trivy:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy scan (HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          format: table
          exit-code: "1"
